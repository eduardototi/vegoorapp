<div class="container order">
  <div class="logo">
    <%= render 'shared/order_header', order: @order %>
  </div>

  <table class="table table-bordered">
    <thead>
      <tr>
        <th scope="col">Cliente</th>
        <th scope="col">CNPJ</th>
        <th scope="col">Telefone</th>
        <th scope="col">Email</th>
        <th scope="col">Endereço</th>
        <th scope="col">Cidade</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <th scope="row"><%= @order.client.razao_social %></th>
        <td><%= @order.client.cnpj %></td>
        <td><%= @order.client.phone %></td>
        <td><%= @order.client.email %></td>
        <td><%= @order.client.street %> Nº: <%= @order.client.number %></td>
        <td><%= @order.client.city %>/<%= @order.client.state %></td>
      </tr>
    </tbody>
  </table>

  <div class="order-description mb-3">
    Descrição:
    <%= @order.description %>
  </div>

  <div class="order-description mb-3 text-justify" >
    Pela presente Ordem de serviço, objetivamos informar os trabalhadores que executam suas atividades laborais nesse setor, conforme estabelece a NR-1 , item 1.7, sobre as condições de segurança e saúde às quais estão expostos, como medida preventiva e ,tendo como parâmetro os agentes físicos, químicos, e biológicos citados na NR-9 - Programa de Prevenção de Riscos Ambientais(Lei nº 6514 de 22/12/1977,Portaria nº 3214 de 08/06/1978), bem como os procedimentos de aplicação da NR-6  - Equipamento de Proteção Individual – EPI , NR-17 – Ergonomia , de forma a padronizar comportamentos para prevenir acidentes e/ou doenças ocupacionais e NR-10 Segurança Em Instalações e Serviços em Eletricidade.
  </div>

  <table class="table table-bordered">
    <thead>
      <tr>
        <th scope="col">Responsável tec.</th>
        <th scope="col">Email</th>
        <th scope="col">Telefone</th>
        <th scope="col">Matrícula</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <th scope="row"><%= @order.user.first_name %> <%= @order.user.last_name %></th>
        <td><%= @order.user.email %></td>
        <td><%= @order.user.phone %></td>
        <td><%= @order.user.registration %></td>
      </tr>
    </tbody>
  </table>

  <table class="table table-bordered">
    <thead>
      <tr>
        <th scope="col">Responsável Cliente</th>
        <th scope="col">Email</th>
        <th scope="col">Telefone</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <th scope="row"><%= @order.contact.first_name %> <%= @order.contact.last_name %></th>
        <td><%= @order.contact.email %></td>
        <td><%= @order.contact.phone %></td>
      </tr>
    </tbody>
  </table>

  <div class="order-description mb-3">
    Local de Execução:
    <%= @order.location %>
  </div>

  <% if @orderservices.count > 0 %>
    <table class="table table-bordered">
      <thead>
        <tr>
          <th scope="col">Descrição dos Serviços</th>
          <th scope="col">Equipamento</th>
          <th scope="col">Série</th>
          <th scope="col">Status</th>
          <th scope="col">Finalizado</th>
          <th>Link</th>
          <th>Link</th>
          <th>Link</th>
        </tr>
      </thead>
        <% @orderservices.each do |orderservice| %>
          <tbody>
            <tr>
              <th scope="row"><%= orderservice.service.title %></th>
              <td scope="row"><%= orderservice.machine.name %></td>
              <td scope="row"><%= orderservice.machineserie %></td>
              <% if orderservice.status %>
                <td><i class="fas fa-check"></i> Finalizada</td>
                <td><%= orderservice.updated_at.strftime("%d/%m/%Y") %> -
                  <%= orderservice.updated_at.strftime("%k:%M") %>h</td>
              <% else %>
                <td><i class="far fa-square"></i> Aberta</td>
                <td></td>
              <% end %>
              <td>
                <% if orderservice.status == false %>
                  <%= link_to 'Resultado', new_orderservice_report_path(orderservice), class: 'btn btn-primary' %>
                <% end %>
              </td>
              <td></td>
              <td></td>
            </tr>
          </tbody>
          <% if orderservice.orderservice_reports.count > 0 %>
            <%= render 'shared/service_reports_show', orderservice: orderservice %>
          <% end %>
          
        <% end %>
    </table>
  <% end %>

  <% @orderservices.each do |orderservice| %>
    <% orderservice.orderservice_reports.each do |result| %>
      <% if result.photos.attached? %>
        <% result.photos.each do |photo| %>
          <%= image_tag photo, height: 300, width: 400, crop: :fill %>
        <% end %>
      <% end %>
    <% end %>
  <% end %>
  

  <div class="order-description mb-3">
    Observações:
    <%= @order.comments %>
  </div>

  <% if @order.utensils.count > 0 %>
    <table class="table table-bordered">
      <thead>
        <tr>
          <th scope="col">Equipamentos</th>
        </tr>
      </thead>
      <% @order.utensils.each do |utensil| %>
        <tbody>
          <tr>
            <td><%= utensil.name %></td>
          </tr>
        </tbody>
      <% end %>
    </table>
  <% end %>

  <% if @epi_orders.count > 0 %>
    <table class="table table-bordered">
      <thead>
        <tr>
          <th scope="col">Quantidade</th>
          <th scope="col">Epi</th>
        </tr>
      </thead>
      <% @epi_orders.each do |epi| %>
        <tbody>
          <tr>
            <td><%= epi.amount %></td>
            <td><%= epi.epi.name %></td>
          </tr>
        </tbody>
      <% end %>
    </table>
  <% end %>

  <div class="links mt-3 text-center">
    <% if @order.canceled %>
      <%= link_to 'Voltar', :back, class: 'btn btn-primary mt-3' %>
    <% else %>
      <%# Ações a serem mostgradas se a ordem estiver aberta %>
      <%  if @order.status == false %>
        <%= link_to 'Editar', edit_order_path(@order), class: 'btn btn-primary' %>
        <%= link_to "Fechar OS", order_close_order_path(@order), class: 'btn btn-primary' %>
        <%= link_to 'Cancelar OS', order_cancel_order_path(@order), class: 'btn btn-primary' %>
      <% else %>
        <%# Ações a serem mostradas se a ordem estiver fechada %>
        <%= link_to "Abrir OS", order_close_order_path(@order), class: 'btn btn-primary' %>  
        <%# Link caso a ordem já tiver um laudo vinculado %>
        <% if @order.vegoor_report %>
          <%= link_to 'Visualizar Laudo', vegoor_report_path(@order.vegoor_report), class: "btn btn-primary" %>
        <% else %>
          <%# Link caso a ordem não tiver um laudo vinculado %>
          <%= link_to 'Gerar Laudo', new_order_vegoor_report_path(@order.id), class: 'btn btn-primary' %>
        <% end %>
      <% end %>
    <% end %>

  </div>
</div>
